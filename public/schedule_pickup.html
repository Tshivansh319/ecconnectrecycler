<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>EcoConnect - Schedule Pickup</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <script src="firebase.js"></script>
  <style>
    body { font-family: Arial; max-width: 600px; margin: 2rem auto; background: #f0f4f8; padding: 2rem; border-radius: 8px; }
    label { display: block; margin-top: 1rem; font-weight: bold; }
    input, select, textarea { width: 100%; padding: 0.5rem; margin-top: 0.3rem; }
    button { margin-top: 1.5rem; background-color: #2c7a7b; color: white; border: none; padding: 0.7rem; cursor: pointer; width: 100%; }
    h2 { color: #2c7a7b; }
  </style>
</head>
<body>
  <h2>Schedule a New Pickup</h2>
  <form id="pickupForm">
    <label for="material">Material Type:</label>
    <select id="material" required>
      <option value="">Select Material</option>
      <option value="Paper">Paper</option>
      <option value="Plastic">Plastic</option>
      <option value="Metal">Metal</option>
      <option value="Glass">Glass</option>
      <option value="Electronics">Electronics</option>
    </select>

    <label for="weight">Estimated Weight (kg):</label>
    <input type="number" id="weight" min="1" required />

    <label for="city">City:</label>
    <input type="text" id="city" disabled />

    <label for="flat">Flat / Society Name:</label>
    <input type="text" id="flat" disabled />

    <label for="note">Additional Notes (optional):</label>
    <textarea id="note" rows="3"></textarea>

    <button type="submit">Submit Pickup Request</button>
  </form>

  <script>
    const db = firebase.firestore();

    firebase.auth().onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }

      const userDoc = await db.collection("users").doc(user.uid).get();
      if (userDoc.exists) {
        const data = userDoc.data();
        document.getElementById("city").value = data.city || "";
        document.getElementById("flat").value = data.flat || "";
      }
    });

    document.getElementById("pickupForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const user = firebase.auth().currentUser;
      if (!user) return alert("User not logged in!");

      const material = document.getElementById("material").value;
      const weight = document.getElementById("weight").value;
      const city = document.getElementById("city").value;
      const flat = document.getElementById("flat").value;
      const note = document.getElementById("note").value;

      try {
        await db.collection("pickups").add({
          userID: user.uid,
          material,
          weight: parseFloat(weight),
          city,
          flat,
          note,
          status: "pending",
          createdAt: new Date()
        });

        alert("Pickup request submitted!");
        document.getElementById("pickupForm").reset();
        window.location.href = "user_dashboard.html";
      } catch (err) {
        alert("Error submitting request: " + err.message);
      }
    });
  </script>
</body>
</html>
